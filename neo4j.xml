<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<?asciidoc-toc?>
<?asciidoc-numbered?>
<article xmlns="http://docbook.org/ns/docbook" lang="en">
<articleinfo>
<title>Neo4j</title>
<date>2015-11-11</date>
<author>
<firstname>Jacek</firstname>

<surname>Sikora</surname>
<email>jaresh@wp.pl</email>
</author>

<authorinitials>JS</authorinitials>



</articleinfo>
<section id="_przygotowanie_danych">
<title>Przygotowanie danych</title>
<programlisting language="bash" linenumbering="unnumbered">time for i in *.7z; do 7za -y -oextracted x $i; done

Size:       937938638
Compressed: 105420265

real	21m53.298s
user	23m13.552s
sys		0m38.260s

image:/images/neo4j_extract.png[]

*31.6 GB danych</programlisting>

<simpara>Ściągam skrypt do przetwarzenia danych do .csv :</simpara>
<programlisting language="bash" linenumbering="unnumbered">git clone https://github.com/mdamien/stackoverflow-neo4j

sudo apt-get install python3-setuptools
easy_install3 xmltodict</programlisting>

<simpara>Uruchamiam skrypt:</simpara>
<programlisting language="bash" linenumbering="unnumbered">python3 to_csv.py extracted

real	73m45.879s
user	71m49.554s
sys	0m30.015s

image:/images/neo4j_tocsv.png[]

*4.2 GB danychi</programlisting>

<simpara>Import danych do bazy Neo4j:</simpara>
<programlisting language="bash" linenumbering="unnumbered">./../../Programy/neo4j-community-2.3.0/bin/neo4j-import \
--into ../../Programy/neo4j-community-2.3.0/data/graph.db \
--id-type string \
--nodes:Post "csvs/posts.csv" \
--nodes:User "csvs/users.csv" \
--nodes:Tag "csvs/tags.csv" \
--relationships:PARENT_OF "csvs/posts_rel.csv" \
--relationships:HAS_TAG "csvs/tags_posts_rel.csv" \
--relationships:POSTED "csvs/users_posts_rel.csv"</programlisting>

<screen>TIP:
Jezeli podczas importu otrzymasz bład dotyczący braku pamieci to należy dodać
do pliku 'neo4j-community-2.3.0/bin/neo4j-import', gdzieś przed wywołaniem
ostatniego polecenia (wartości -Xms -Xmx zależnie od dostepnej pamięci):

[source, bash]</screen>

<simpara>JAVA_OPTS="-Xms2048m -Xmx2048m"</simpara>
<screen></screen>

<simpara>IMPORT DONE in 26m 41s 500ms. Imported:
  25247894 nodes
  58817742 relationships
  126491554 properties</simpara>
</section>
<section id="_analiza_danych">
<title>Analiza danych</title>
<formalpara>
<title>Ile danych mamy w bazie:</title>
<para>
<screen>neo4j-sh (?)$ match (n) return head(labels(n)) as label, count(*);

image:/images/neo4j_1query.png[]</screen>
</para>
</formalpara>

<formalpara>
<title>Dodanie indeksów:</title>
<para>
<screen>create index on :Post(title);
create index on :Post(createdAt);
create index on :Post(score);
create index on :Post(views);
create index on :Post(favorites);
create index on :Post(answers);
create index on :Post(score);

create index on :User(name);
create index on :User(createdAt);
create index on :User(reputation);
create index on :User(age);

create index on :Tag(count);

create constraint on (t:Tag) assert t.tagId is unique;
create constraint on (u:User) assert u.userId is unique;
create constraint on (p:Post) assert p.postId is unique;</screen>
</para>
</formalpara>

</section>
</article>